<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maze Math (Laptop)</title>
  <style>
    :root{
      --bg:#121212; --card:rgba(255,255,255,.08);
      --accent:#3498db; --ok:#2ecc71; --bad:#e74c3c;
      --muted:rgba(255,255,255,.18);
      --purple:#8e44ad;
    }
    body{margin:0;background:var(--bg);color:#fff;font-family:Arial;text-align:center;padding:14px;}
    .card{max-width:760px;margin:0 auto;background:var(--card);padding:16px;border-radius:16px;}
    h1{font-size:clamp(28px,4.5vw,48px);margin:10px 0;}
    h2{font-size:clamp(18px,3.2vw,28px);margin:10px 0;}
    button{width:100%;padding:14px 12px;font-size:20px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:bold;margin:6px 0;cursor:pointer;}
    button:active{transform:scale(.99);}
    .green{background:var(--ok);} .red{background:var(--bad);} .muted{background:var(--muted);}
    input{font-size:28px;padding:12px 14px;margin:10px 0;border-radius:12px;border:none;width:min(320px,80%);text-align:center;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;}
    .dirs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;max-width:360px;margin:12px auto 0;}
    .dirs button{margin:0;font-size:22px;padding:14px 0;transition:transform .08s ease;}
    .hud{margin-top:10px;font-size:18px;opacity:.95;}
    canvas{width:100%;max-width:720px;aspect-ratio: 10/7;background:rgba(0,0,0,.25);border-radius:14px;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.04);}100%{transform:scale(1);}}
    .hot{box-shadow:0 0 0 2px rgba(46,204,113,.5),0 0 26px rgba(46,204,113,.35); animation:pulse .65s ease-in-out infinite;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);margin:0 6px 6px 0;font-size:14px;}
    .small{font-size:14px;opacity:.9;}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Maze Math</h2>

    <div id="menu"></div>

    <div id="play" style="display:none;">
      <div id="msg" style="font-size:20px;min-height:28px;margin:6px 0;"></div>

      <canvas id="cv" width="900" height="630"></canvas>

      <h1 id="expr">...</h1>

      <div class="row">
        <input id="ans" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="antwoord" />
        <button id="btnCheck" style="max-width:220px;">Check</button>
      </div>

      <div class="dirs">
        <div></div><button id="up">‚¨ÜÔ∏è</button><div></div>
        <button id="left">‚¨ÖÔ∏è</button><button id="down">‚¨áÔ∏è</button><button id="right">‚û°Ô∏è</button>
      </div>

      <div class="hud" id="hud"></div>

      <div class="row" style="margin-top:10px;">
        <span class="pill" id="modepill"></span>
        <span class="pill">Streak basis max 2 ‚Ä¢ Coins +1 stap/beurt ‚Ä¢ Max 5 stappen/beurt</span>
      </div>

      <button class="muted" id="back" style="margin-top:14px;">Menu</button>
    </div>
  </div>

<script>
(() => {
  // ============================================================
  // Config
  // ============================================================
  const MAX_TOTAL_STEPS_PER_TURN = 5;
  const MAX_STREAK_STEPS = 2; // streak geeft nooit meer dan 2 stappen
  const COINS_PER_MAZE = 7;   // aantal coins in elke maze

  // ============================================================
  // State
  // ============================================================
  const state = {
    screen: 0,      // 0 menu+naam, 1 tafels, 2 sommen, 3 play
    tableMode: 0,   // 0 none, 1..10 fixed, 11 MIX
    sumMode: 0,     // 0 none, 1 PLUS, 2 MIN

    // quiz
    selectedTable: 8,
    multiplier: 1,
    numA: 0, numB: 0,
    op: 'x',
    correct: 0,

    streak: 0,
    movesLeft: 0,

    // maze
    mw: 10, mh: 7,
    walls: null,     // Uint8Array, bits 1=N 2=E 4=S 8=W (1 means WALL)
    px: 0, py: 0,
    gx: 9, gy: 6,

    // coins
    coinsMap: null,        // Uint8Array mw*mh (0/1)
    coinsThisMaze: 0,

    // player / diamonds
    playerName: "",
    diamonds: 0,

    // UI
    bg: '#121212',
    msg: ''
  };

  // no-repeat multipliers
  const lastN = 5;
  const lastMult = new Array(lastN).fill(0);
  let lastPos = 0;
  function resetNoRepeat(){ lastMult.fill(0); lastPos = 0; }
  function inLastMult(m){ return lastMult.includes(m); }
  function pushLastMult(m){ lastMult[lastPos]=m; lastPos=(lastPos+1)%lastN; }

  // ============================================================
  // API calls (server.js)
  // ============================================================
  async function apiGetProfile(name){
    const r = await fetch(`/api/profile?name=${encodeURIComponent(name)}`);
    if(!r.ok) throw new Error("Profile ophalen faalde");
    return await r.json(); // {name, diamonds}
  }

  async function apiSaveProfile(profile){
    const r = await fetch(`/api/profile`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(profile)
    });
    if(!r.ok) throw new Error("Profile opslaan faalde");
    return await r.json();
  }

  // ============================================================
  // DOM
  // ============================================================
  const $ = id => document.getElementById(id);
  const cv = $('cv');
  const g = cv.getContext('2d');

  function showMenu(){ $('menu').style.display='block'; $('play').style.display='none'; }
  function showPlay(){ $('menu').style.display='none'; $('play').style.display='block'; }

  function setArrowGlow(on){
    ['up','down','left','right'].forEach(id => $(id).classList.toggle('hot', on));
  }

  function stepsForStreak(s){
    // basis (cap 2): 1‚Äì2 => 1 stap, 3+ => 2 stappen
    if (s >= 3) return 2;
    return 1;
  }

  function computeStepsAward(){
    const base = Math.min(MAX_STREAK_STEPS, stepsForStreak(state.streak));
    const coinBonus = state.coinsThisMaze; // +1 per coin
    return Math.min(MAX_TOTAL_STEPS_PER_TURN, base + coinBonus);
  }

  // ============================================================
  // Maze helpers
  // ============================================================
  function idx(x,y){ return y*state.mw + x; }
  function inBounds(x,y){ return x>=0 && x<state.mw && y>=0 && y<state.mh; }

  // ============================================================
  // Maze generation (perfect maze DFS)
  // ============================================================
  function initWallsAll(){
    const n = state.mw * state.mh;
    state.walls = new Uint8Array(n);
    for(let i=0;i<n;i++) state.walls[i] = 1|2|4|8;
  }

  function knockDownWall(x1,y1,x2,y2){
    const a = idx(x1,y1), b = idx(x2,y2);
    if (x2===x1 && y2===y1-1){ state.walls[a] &= ~1; state.walls[b] &= ~4; }
    if (x2===x1+1 && y2===y1){ state.walls[a] &= ~2; state.walls[b] &= ~8; }
    if (x2===x1 && y2===y1+1){ state.walls[a] &= ~4; state.walls[b] &= ~1; }
    if (x2===x1-1 && y2===y1){ state.walls[a] &= ~8; state.walls[b] &= ~2; }
  }

  function generateCoins(){
    const n = state.mw * state.mh;
    state.coinsMap = new Uint8Array(n);

    let placed = 0;
    let guard = 0;
    while(placed < COINS_PER_MAZE && guard < 2000){
      guard++;
      const x = Math.floor(Math.random()*state.mw);
      const y = Math.floor(Math.random()*state.mh);
      if((x===0 && y===0) || (x===state.gx && y===state.gy)) continue;
      const id = idx(x,y);
      if(state.coinsMap[id]) continue;
      state.coinsMap[id] = 1;
      placed++;
    }
  }

  function generateMaze(){
    initWallsAll();
    const n = state.mw * state.mh;
    const vis = new Array(n).fill(false);
    const stack = [];

    vis[idx(0,0)] = true;
    stack.push(idx(0,0));

    while(stack.length){
      const cur = stack[stack.length-1];
      const cx = cur % state.mw;
      const cy = Math.floor(cur / state.mw);

      const neigh = [];
      if(inBounds(cx,cy-1) && !vis[idx(cx,cy-1)]) neigh.push([cx,cy-1]);
      if(inBounds(cx+1,cy) && !vis[idx(cx+1,cy)]) neigh.push([cx+1,cy]);
      if(inBounds(cx,cy+1) && !vis[idx(cx,cy+1)]) neigh.push([cx,cy+1]);
      if(inBounds(cx-1,cy) && !vis[idx(cx-1,cy)]) neigh.push([cx-1,cy]);

      if(neigh.length===0){ stack.pop(); continue; }

      const [tx,ty] = neigh[Math.floor(Math.random()*neigh.length)];
      knockDownWall(cx,cy,tx,ty);
      vis[idx(tx,ty)] = true;
      stack.push(idx(tx,ty));
    }

    // random corner-ish goal
    const corners = [[state.mw-1,state.mh-1],[state.mw-1,0],[0,state.mh-1]];
    [state.gx,state.gy] = corners[Math.floor(Math.random()*corners.length)];

    state.px = 0; state.py = 0;

    generateCoins();
    state.coinsThisMaze = 0;
  }

  function collectCoinIfAny(){
    const id = idx(state.px, state.py);
    if(state.coinsMap && state.coinsMap[id] === 1){
      state.coinsMap[id] = 0;
      state.coinsThisMaze++;
      feedback('#121212', `ü™ô Coin! Je hebt nu ${state.coinsThisMaze} coin(s) (+${state.coinsThisMaze} stap/beurt).`);
    }
  }

  // ============================================================
  // Draw
  // ============================================================
  function drawMaze(){
    const mw=state.mw, mh=state.mh;
    const pad=18;
    const cw=(cv.width-2*pad)/mw;
    const ch=(cv.height-2*pad)/mh;

    g.clearRect(0,0,cv.width,cv.height);

    // walls
    g.globalAlpha = 0.92;
    g.lineWidth = 4;
    g.strokeStyle = 'rgba(255,255,255,0.82)';

    function cellId(x,y){ return y*mw+x; }

    for(let y=0;y<mh;y++){
      for(let x=0;x<mw;x++){
        const wx = state.walls[cellId(x,y)];
        const x0=pad+x*cw, y0=pad+y*ch;
        const x1=x0+cw, y1=y0+ch;
        g.beginPath();
        if(wx&1){ g.moveTo(x0,y0); g.lineTo(x1,y0); }
        if(wx&2){ g.moveTo(x1,y0); g.lineTo(x1,y1); }
        if(wx&4){ g.moveTo(x0,y1); g.lineTo(x1,y1); }
        if(wx&8){ g.moveTo(x0,y0); g.lineTo(x0,y1); }
        g.stroke();
      }
    }

    // coins
    if(state.coinsMap){
      for(let y=0;y<mh;y++){
        for(let x=0;x<mw;x++){
          if(state.coinsMap[cellId(x,y)]){
            const cx=pad+(x+0.5)*cw;
            const cy=pad+(y+0.52)*ch;
            g.globalAlpha=1;
            g.font=`${Math.floor(Math.min(cw,ch)*0.42)}px Arial`;
            g.textAlign='center'; g.textBaseline='middle';
            g.fillText('ü™ô', cx, cy);
          }
        }
      }
    }

    // goal
    const gx=pad+(state.gx+0.5)*cw;
    const gy=pad+(state.gy+0.5)*ch;
    g.globalAlpha=1;
    g.fillStyle='rgba(46,204,113,0.9)';
    g.beginPath(); g.arc(gx,gy,Math.min(cw,ch)*0.22,0,Math.PI*2); g.fill();
    g.fillStyle='rgba(0,0,0,0.65)';
    g.font=`${Math.floor(Math.min(cw,ch)*0.38)}px Arial`;
    g.textAlign='center'; g.textBaseline='middle';
    g.fillText('üèÅ', gx, gy+1);

    // player
    const px=pad+(state.px+0.5)*cw;
    const py=pad+(state.py+0.5)*ch;
    g.fillStyle='rgba(52,152,219,0.95)';
    g.beginPath(); g.arc(px,py,Math.min(cw,ch)*0.24,0,Math.PI*2); g.fill();
    g.fillStyle='rgba(0,0,0,0.65)';
    g.fillText('üôÇ', px, py+1);
  }

  // ============================================================
  // Quiz
  // ============================================================
  function generateQuestion(){
    if(state.tableMode !== 0){
      const t = (state.tableMode===11) ? (1+Math.floor(Math.random()*10)) : state.tableMode;
      state.selectedTable = t;

      let m = 0;
      for(let tries=0; tries<60; tries++){
        const c = 1+Math.floor(Math.random()*10);
        if(!inLastMult(c)){ m=c; break; }
      }
      if(!m) m = 1+Math.floor(Math.random()*10);
      pushLastMult(m);

      state.multiplier = m;
      state.op = 'x';
      state.correct = state.selectedTable * state.multiplier;
      return;
    }

    if(state.sumMode===1){
      state.numA = Math.floor(Math.random()*11);
      state.numB = Math.floor(Math.random()*(11-state.numA));
      state.op = '+';
      state.correct = state.numA + state.numB;
      return;
    }

    if(state.sumMode===2){
      state.numA = Math.floor(Math.random()*11);
      state.numB = Math.floor(Math.random()*(state.numA+1));
      state.op = '-';
      state.correct = state.numA - state.numB;
      return;
    }
  }

  function exprString(){
    if(state.tableMode !== 0) return `${state.multiplier} x ${state.selectedTable}`;
    return `${state.numA} ${state.op} ${state.numB}`;
  }

  // ============================================================
  // Moves
  // ============================================================
  function tryMove(dir){
    const w = state.walls[idx(state.px,state.py)];
    let x=state.px, y=state.py;

    if(dir==='U'){ if(w&1) return false; y--; }
    if(dir==='R'){ if(w&2) return false; x++; }
    if(dir==='D'){ if(w&4) return false; y++; }
    if(dir==='L'){ if(w&8) return false; x--; }

    if(!inBounds(x,y)) return false;
    state.px=x; state.py=y;
    return true;
  }

  function atGoal(){ return state.px===state.gx && state.py===state.gy; }

  // ============================================================
  // Lucky pot (diamonds)
  // ============================================================
  function rollLuckyPotDiamonds(coins){
    // 5..25 met meer kans op laag. Meer coins => hogere kans op hoger.
    const min=5, max=25;
    const u = Math.random();

    // p: hoger = meer lage waardes. coins maken p lager.
    const p = Math.max(1.15, 3.2 - coins*0.18);

    let d = min + Math.floor((max - min + 1) * Math.pow(u, p));
    // kleine extra boost door coins (voelbaar maar niet kapot)
    d += Math.min(6, Math.floor(coins / 2));

    if(d < min) d = min;
    if(d > max) d = max;
    return d;
  }

  async function awardLuckyPot(){
    const won = rollLuckyPotDiamonds(state.coinsThisMaze);
    state.diamonds += won;
    await apiSaveProfile({ name: state.playerName, diamonds: state.diamonds });

    feedback('#8e44ad', `üçÄ Lucky pot! ${state.coinsThisMaze} coin(s) ‚Üí +${won} üíé! Totaal: ${state.diamonds} üíé`);
  }

  // ============================================================
  // UI render
  // ============================================================
  function render(){
    document.body.style.background = state.bg;
    $('msg').innerText = state.msg || '';
    $('expr').innerText = exprString();

    $('hud').innerText =
      `Speler: ${state.playerName || '-'}  |  üíé ${state.diamonds}  |  ü™ô (maze) ${state.coinsThisMaze}  |  Streak: ${state.streak}  |  Stappen: ${state.movesLeft}`;

    $('modepill').innerText =
      state.tableMode ? (state.tableMode===11 ? 'Mode: Tafels MIX' : `Mode: Tafel ${state.tableMode}`) :
      state.sumMode===1 ? 'Mode: PLUS' :
      state.sumMode===2 ? 'Mode: MIN' : 'Mode: ?';

    if(state.screen===0){
      $('title').innerText='Maze Math ‚Äî speler kiezen';
      $('menu').innerHTML = `
        <div class="small">Diamantjes worden per naam bewaard in players.json.</div>
        <input id="nameInput" type="text" placeholder="jouw naam" />
        <button id="btnName" class="green">Start</button>
        <div style="height:10px"></div>
        <div id="afterName" style="display:none;">
          <button id="goTables">‚úñÔ∏è Tafels</button>
          <button id="goSums" class="green">‚ûï Sommen</button>
        </div>
      `;
      showMenu();

      const ni = $('nameInput');
      ni.value = state.playerName || "";
      ni.focus({preventScroll:true});

      $('btnName').onclick = async () => {
        const name = ni.value.trim();
        if(!name){
          state.msg = "Typ eerst je naam üôÇ";
          render();
          return;
        }
        await loadPlayer(name);
        $('afterName').style.display = 'block';
        state.msg = `Welkom ${state.playerName}! Je hebt ${state.diamonds} üíé. Kies een spel.`;
        $('goTables').onclick=()=>{ state.screen=1; state.bg='#121212'; state.msg=''; render(); };
        $('goSums').onclick=()=>{ state.screen=2; state.bg='#121212'; state.msg=''; render(); };
        render();
      };

      if(state.playerName){
        $('afterName').style.display='block';
        $('goTables').onclick=()=>{ state.screen=1; state.bg='#121212'; state.msg=''; render(); };
        $('goSums').onclick=()=>{ state.screen=2; state.bg='#121212'; state.msg=''; render(); };
      }
      return;
    }

    if(state.screen===1){
      $('title').innerText='Tafels: kies een tafel';
      let h = `<div class="grid">`;
      for(let i=1;i<=10;i++) h += `<button class="btnT" data-t="${i}">Tafel ${i}</button>`;
      h += `</div>`;
      h += `<button class="muted" id="mix">üé≤ MIX</button>`;
      h += `<button class="muted" id="backMenu">Menu</button>`;
      $('menu').innerHTML = h;

      document.querySelectorAll('.btnT').forEach(b=>{
        b.onclick=()=>{
          state.tableMode = Number(b.dataset.t);
          state.sumMode = 0;
          startGame();
        };
      });
      $('mix').onclick=()=>{ state.tableMode=11; state.sumMode=0; startGame(); };
      $('backMenu').onclick=()=>{ state.screen=0; render(); };

      showMenu();
      return;
    }

    if(state.screen===2){
      $('title').innerText='Sommen: kies plus of min';
      $('menu').innerHTML = `
        <button class="green" id="plus">PLUS (+)</button>
        <button class="red" id="min">MIN (-)</button>
        <button class="muted" id="backMenu">Menu</button>
      `;
      $('plus').onclick=()=>{ state.sumMode=1; state.tableMode=0; startGame(); };
      $('min').onclick=()=>{ state.sumMode=2; state.tableMode=0; startGame(); };
      $('backMenu').onclick=()=>{ state.screen=0; render(); };

      showMenu();
      return;
    }

    // play
    $('title').innerText='Maze Math';
    showPlay();
    drawMaze();
    setArrowGlow(state.movesLeft > 0);

    requestAnimationFrame(()=>{
      const a=$('ans');
      a.focus({preventScroll:true});
    });
  }

  async function loadPlayer(name){
    const prof = await apiGetProfile(name);
    state.playerName = prof.name || name;
    state.diamonds = Number(prof.diamonds || 0);
    localStorage.setItem("mazeMath:lastPlayer", state.playerName);
  }

  function startGame(){
    state.screen = 3;
    state.streak = 0;
    state.movesLeft = 0;
    state.msg = 'Start! Los de som op üôÇ';
    state.bg = '#121212';

    resetNoRepeat();
    generateMaze();
    generateQuestion();
    render();
  }

  // ============================================================
  // Interactions
  // ============================================================
  function feedback(bg, msg){
    state.bg = bg;
    state.msg = msg;
  }

  function checkAnswer(){
    const a = $('ans');
    const v = a.value.trim();
    if(v===''){ a.focus(); return; }

    const user = Number(v);
    a.value = '';

    if(user === state.correct){
      state.streak++;
      state.movesLeft = computeStepsAward();
      feedback('#2ecc71', `Juist! Streak ${state.streak} ‚úÖ ‚Üí ${state.movesLeft} stap(pen) (basis + coins).`);
    } else {
      state.streak = 0;
      state.movesLeft = 0;
      feedback('#e74c3c', `Fout‚Ä¶ streak terug naar 0 üôÇ`);
      generateQuestion();
    }
    render();
  }

  async function doMove(dir){
    if(state.screen !== 3) return;

    if(state.movesLeft <= 0){
      feedback('#121212', 'üîí Eerst juist antwoorden om te bewegen!');
      render();
      return;
    }

    const ok = tryMove(dir);
    if(!ok){
      feedback('#121212', 'Muur! ‚ùå Probeer andere richting.');
      render();
      return;
    }

    collectCoinIfAny();

    state.movesLeft--;

    if(atGoal()){
      await awardLuckyPot();

      generateMaze();
      state.streak = 0;
      state.movesLeft = 0;
      generateQuestion();
      render();
      return;
    }

    if(state.movesLeft > 0){
      // alleen een standaard msg als coin msg niet net gezet werd
      if(!state.msg.startsWith('ü™ô Coin!')){
        feedback('#121212', `Nice! Nog ${state.movesLeft} stap(pen) üôÇ`);
      }
      render();
      return;
    }

    generateQuestion();
    feedback('#121212', 'Top! Volgende vraag üôÇ');
    render();
  }

  // bind once
  $('btnCheck').onclick = checkAnswer;
  $('back').onclick = ()=>{ state.screen=0; state.tableMode=0; state.sumMode=0; state.bg='#121212'; state.msg=''; render(); };

  $('up').onclick=()=>doMove('U');
  $('down').onclick=()=>doMove('D');
  $('left').onclick=()=>doMove('L');
  $('right').onclick=()=>doMove('R');

  $('ans').addEventListener('keydown', e => { if(e.key==='Enter') checkAnswer(); });
  window.addEventListener('keydown', e => {
    if(state.screen!==3) return;
    if(e.key==='ArrowUp') doMove('U');
    if(e.key==='ArrowDown') doMove('D');
    if(e.key==='ArrowLeft') doMove('L');
    if(e.key==='ArrowRight') doMove('R');
  });

  // start at menu + auto-load last player (handig)
  (async ()=>{
    const last = localStorage.getItem("mazeMath:lastPlayer");
    if(last){
      try { await loadPlayer(last); } catch {}
    }
    render();
  })();
})();
</script>
</body>
</html>

